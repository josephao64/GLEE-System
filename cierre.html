<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cierre Diario de Ventas</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Firebase (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- SweetAlert2 para mensajes (opcional) -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container mt-4">
    <h1 class="mb-4">Cierre Diario de Ventas</h1>
    
    <!-- Sección 1: Consultar Ventas por Fecha -->
    <div class="card mb-4">
      <div class="card-header">
        Consultar Ventas
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="fechaConsulta" class="form-label">Seleccione la fecha (YYYY-MM-DD):</label>
          <input type="date" id="fechaConsulta" class="form-control">
        </div>
        <button id="btnConsultar" class="btn btn-primary">Consultar Ventas</button>
      </div>
    </div>
    
    <!-- Sección 2: Tabla de Ventas y Totales -->
    <div class="card mb-4">
      <div class="card-header">
        Ventas del Día
      </div>
      <div class="card-body">
        <table class="table table-bordered" id="tablaVentas">
          <thead>
            <tr>
              <th>ID Venta</th>
              <th>Método de Pago</th>
              <th>Monto</th>
            </tr>
          </thead>
          <tbody>
            <!-- Se cargarán dinámicamente las ventas -->
          </tbody>
        </table>
        <div class="mt-3">
          <p><strong>Total Efectivo:</strong> Q <span id="totalEfectivo">0.00</span></p>
          <p><strong>Total Tarjeta:</strong> Q <span id="totalTarjeta">0.00</span></p>
          <p><strong>Total General:</strong> Q <span id="totalGeneral">0.00</span></p>
        </div>
      </div>
    </div>
    
    <!-- Sección 3: Realizar Cierre -->
    <div class="card mb-4">
      <div class="card-header">
        Realizar Cierre
      </div>
      <div class="card-body">
        <button id="btnRealizarCierre" class="btn btn-success">Realizar Cierre</button>
        <!-- Esta sección se mostrará al presionar "Realizar Cierre" -->
        <div id="cierreSection" class="mt-3" style="display: none;">
          <div class="mb-3">
            <label for="fechaCierre" class="form-label">Fecha de Cierre (YYYY-MM-DD):</label>
            <input type="date" id="fechaCierre" class="form-control">
          </div>
          <button id="btnConfirmarCierre" class="btn btn-primary">Confirmar Cierre</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Lógica de Conexión a Firebase y Funcionalidades -->
  <script>
    // Sección 1: Configuración de Firebase
    var firebaseConfig = {
      apiKey: "AIzaSyAjVTKBJwZ8qql32ZrZBy0Q1NFUYMu-Xzk",
      authDomain: "gleedb-5d36a.firebaseapp.com",
      projectId: "gleedb-5d36a",
      storageBucket: "gleedb-5d36a.appspot.com",
      messagingSenderId: "1090238022032",
      appId: "1:1090238022032:web:c637b0a6dfe06be5287315"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    // Variables globales para almacenar ventas y totales
    let ventasDelDia = [];
    let totalEfectivo = 0;
    let totalTarjeta = 0;
    let totalGeneral = 0;

    // Función auxiliar para formatear números a dos decimales
    function formatMoney(num) {
      return num.toFixed(2);
    }

    // Sección 2: Lógica para Consultar Ventas
    document.getElementById('btnConsultar').addEventListener('click', function() {
      let fechaConsulta = document.getElementById('fechaConsulta').value;
      if (!fechaConsulta) {
        Swal.fire('Error', 'Seleccione una fecha para consultar ventas.', 'error');
        return;
      }
      
      // Reiniciar datos
      ventasDelDia = [];
      totalEfectivo = 0;
      totalTarjeta = 0;
      totalGeneral = 0;
      document.querySelector('#tablaVentas tbody').innerHTML = '';
      
      /* 
         Se asume que en la colección "ventas" se tiene un campo "fecha" con formato ISO 
         o al menos que incluya "YYYY-MM-DD". La consulta se realiza para ventas cuyo campo 
         "fecha" esté entre la fecha seleccionada y el día siguiente.
      */
      let inicio = fechaConsulta;
      let fin = new Date(new Date(fechaConsulta).setDate(new Date(fechaConsulta).getDate() + 1));
      fin = fin.toISOString().split('T')[0];

      db.collection("ventas")
        .where("fecha", ">=", inicio)
        .where("fecha", "<", fin)
        .get()
        .then((querySnapshot) => {
          if (querySnapshot.empty) {
            Swal.fire('Información', 'No se encontraron ventas para la fecha seleccionada.', 'info');
          }
          querySnapshot.forEach((doc) => {
            let venta = doc.data();
            venta.id = doc.id;
            ventasDelDia.push(venta);
            // Calcular totales según el método de pago
            if (venta.metodo_pago.toLowerCase() === "efectivo") {
              totalEfectivo += venta.total;
            } else if (venta.metodo_pago.toLowerCase() === "tarjeta") {
              totalTarjeta += venta.total;
            }
            totalGeneral += venta.total;
            // Agregar fila a la tabla
            let tr = document.createElement('tr');
            tr.innerHTML = `<td>${venta.id}</td>
                            <td>${venta.metodo_pago}</td>
                            <td>Q ${formatMoney(venta.total)}</td>`;
            document.querySelector('#tablaVentas tbody').appendChild(tr);
          });
          // Mostrar totales
          document.getElementById('totalEfectivo').textContent = formatMoney(totalEfectivo);
          document.getElementById('totalTarjeta').textContent = formatMoney(totalTarjeta);
          document.getElementById('totalGeneral').textContent = formatMoney(totalGeneral);
        })
        .catch((error) => {
          console.error("Error consultando ventas: ", error);
          Swal.fire('Error', 'No se pudo consultar las ventas. Intente nuevamente.', 'error');
        });
    });

    // Sección 3: Mostrar campo para realizar el cierre
    document.getElementById('btnRealizarCierre').addEventListener('click', function() {
      if (ventasDelDia.length === 0) {
        Swal.fire('Error', 'No hay ventas registradas para realizar el cierre. Consulte las ventas primero.', 'error');
        return;
      }
      document.getElementById('cierreSection').style.display = 'block';
    });

    // Sección 4: Realizar el cierre y guardar en Firestore
    document.getElementById('btnConfirmarCierre').addEventListener('click', function() {
      let fechaCierre = document.getElementById('fechaCierre').value;
      if (!fechaCierre) {
        Swal.fire('Error', 'Ingrese la fecha de cierre.', 'error');
        return;
      }
      // Obtener la hora actual en formato HH:MM:SS
      let now = new Date();
      let horaCierre = now.toTimeString().split(' ')[0];

      // Crear objeto de cierre con los totales
      let cierre = {
        fechaCierre: fechaCierre,
        totalEfectivo: totalEfectivo,
        totalTarjeta: totalTarjeta,
        totalGeneral: totalGeneral,
        horaCierre: horaCierre
      };

      // Guardar el objeto en la colección "cierres"
      db.collection("cierres").add(cierre)
        .then(() => {
          Swal.fire('Éxito', 'Cierre realizado con éxito.', 'success');
          // Reiniciar secciones y totales
          ventasDelDia = [];
          totalEfectivo = 0;
          totalTarjeta = 0;
          totalGeneral = 0;
          document.querySelector('#tablaVentas tbody').innerHTML = '';
          document.getElementById('totalEfectivo').textContent = "0.00";
          document.getElementById('totalTarjeta').textContent = "0.00";
          document.getElementById('totalGeneral').textContent = "0.00";
          document.getElementById('fechaConsulta').value = "";
          document.getElementById('fechaCierre').value = "";
          document.getElementById('cierreSection').style.display = 'none';
        })
        .catch((error) => {
          console.error("Error al guardar el cierre: ", error);
          Swal.fire('Error', 'No se pudo realizar el cierre. Intente nuevamente.', 'error');
        });
    });
  </script>
</body>
</html>
